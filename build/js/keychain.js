function Keychain(){this.AUTOLOCK_LENGTH=6e4,this.autoLogoutTime=null,this.contents={},this.encryptionKeys=null,this._all=null,this.masterPassword=null,this.encryptionKeysLoaded=!1}function KeychainItemOverview(e){this.uuid=e[INDEX_UUID],this.type=e[INDEX_TYPE],this.title=e[INDEX_NAME],this.domain=e[INDEX_URL],this.updatedAtMs=1e3*e[INDEX_DATE],this.trashed=e[INDEX_TRASHED];var t=new Date;t.setTime(this.updatedAtMs)}function encodeToHex(e){for(var t,i="",n=e.length,r=0;n>r;){for(t=e.charCodeAt(r++).toString(16);t.length<2;)t="0"+t;i+=t}return i.toUpperCase()}var INDEX_UUID=0,INDEX_TYPE=1,INDEX_NAME=2,INDEX_URL=3,INDEX_DATE=4,INDEX_FOLDER=5,INDEX_PASSWORD_STRENGTH=6,INDEX_TRASHED=7,TYPE_WEBFORMS="webforms.WebForm",TYPE_FOLDERS="system.folder.Regular",TYPE_NOTES="securenotes.SecureNote",TYPE_IDENTITIES="identities.Identity",TYPE_PASSWORDS="passwords.Password",TYPE_WALLET="wallet",TYPE_SOFTWARE_LICENSES="wallet.computer.License",TYPE_TRASHED="trashed",TYPE_ACCOUNT="account",TYPE_ACCOUNT_ONLINESERVICE="wallet.onlineservices.",TYPE_ACCOUNT_COMPUTER="wallet.computer.",ERROR_BAD_DECRYPT="Decryption failed",ERROR_INVALID_JSON="Decryption passed but JSON was invalid",ERROR_OK="OK";Keychain.prototype.setEncryptionKeys=function(e){this.encryptionKeys=e,this.encryptionKeysLoaded=!0},Keychain.prototype.verifyPassword=function(e){GibberishAES.size(128),this.encryptionKeys.decryptedKeys={};var t=this.decryptEncryptionKey("SL5",e);return t?(this.masterPassword=e,!0):!1},Keychain.prototype.decryptEncryptionKey=function(e,t){for(var i=0;i<this.encryptionKeys.list.length;i++){var n=this.encryptionKeys.list[i];if(n.identifier==this.encryptionKeys[e]){var r=parseInt(n.iterations||"0",10);1e3>r&&(r=1e3);var s=GibberishAES.decryptUsingPBKDF2(n.data,t,r);if(!s)return null;var o=GibberishAES.decryptBase64UsingKey(n.validation,GibberishAES.s2a(s));return o!=s?null:(this.encryptionKeys.decryptedKeys[e]=s,s)}}},Keychain.prototype.keyForItem=function(e){if(null==e.securityLevel)return this.encryptionKeys.decryptedKeys.SL5;var t=this.encryptionKeys.decryptedKeys[e.securityLevel];return t||(t=this.decryptEncryptionKey(e.securityLevel,this.masterPassword)),t},Keychain.prototype.setContents=function(e){return this._all={},e.forEach(function(e){var t=new KeychainItemOverview(e);if(0!==t.type.indexOf("system.")){this._all[t.uuid]=t;var i=t.type||TYPE_ACCOUNT;"Y"==t.trashed?i=TYPE_TRASHED:0===i.indexOf(TYPE_FOLDERS)?i="folders":i.search(/^wallet/)>-1&&(i=TYPE_WALLET),this.contents[i]?this.contents[i].push(t):this.contents[i]=[t]}},this),this.contents},Keychain.prototype.itemsOfType=function(e){return this.contents[e]},Keychain.prototype.itemWithUuid=function(e){return this._all[e]},Keychain.prototype._autoLogout=function(){Bus.emit("logout",!0)},Keychain.prototype.lock=function(){this.encryptionKeys&&(this.encryptionKeys.decryptedKeys=null),this.masterPassword=null,this.encryptionKeysLoaded=!1},KeychainItemOverview.prototype.matches=function(e){var t=new RegExp(e,"i");return t.test(this.title)||t.test(this.domain)},Keychain.prototype.getItem=function(e){var t={};return t.updatedAt=null,t.data=e,t.folderUuid=e.folderUuid,t.encrypted_contents=e.encrypted,t.decrypted=!1,t.decrypted_secure_contents=null,t.uuid=e.uuid,t.type=e.typeName,t.title=e.title,t.domain=e.location,t.securityLevel=e.securityLevel,!e.securityLevel&&e.openContents&&(t.securityLevel=e.openContents.securityLevel),t.securityLevel||(t.securityLevel="SL5"),t.updatedAtMs=1e3*e.updatedAt,t},Keychain.prototype.decryptItem=function(e){GibberishAES.size(128);var t=this.keyForItem(e),i=GibberishAES.decryptBase64UsingKey(e.encrypted_contents,GibberishAES.s2a(t));if(!i)return ERROR_BAD_DECRYPT;i=decodeURIComponent(escape(i));try{e.decrypted_secure_contents=JSON.parse(i)}catch(n){return ERROR_INVALID_JSON}return ERROR_OK},Keychain.prototype.findItemFieldWithDesignation=function(e,t){var i=e.decrypted_secure_contents.fields.filter(function(e){return e.designation==t})[0];return i};